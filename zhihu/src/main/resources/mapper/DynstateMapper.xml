<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 映射文件的命名空间namespace的值是，与这对应的映射接口的全类名 -->
<mapper namespace="com.yc.zhihu.mapper.DynstateMapper">
	<select id="list" parameterType="PaginationBean" resultType="Dynstate">
  select * from(
       select inside.* ,rownum rn from(
       select * from dynstate
		<if test="sgin != 'all'">
			PARTITION(${sgin})
		</if>
		<if test="sgin == 'all'">

		</if>
		) inside where ${pageSize}*${currPage}>=rownum)where rn>(${currPage}-1)*${pageSize}
	</select>

	<resultMap type="Reply" id="ReplyMap">
		<id column="rid" property="rid" />
		<result column="reqid" property="reqid" />
		<result column="rkind" property="rkind" />
		<result column="rrid" property="rrid" />
		<result column="remitid" property="remitid" />
		<result column="rreceid" property="rreceid" />
		<result column="rcontent" property="rcontent" />
		<result column="rtime" property="rtime" />

		<collection property="users" ofType="Users">
			<id column="uids" property="uids" />
			<result column="upassword" property="upassword" />
			<result column="usign" property="usign" />
			<result column="uage" property="uage" />
			<result column="ugender" property="ugender" />
			<result column="uprofession" property="uprofession" />
			<result column="uname" property="uname" />
			<result column="upic" property="upic" />
			<result column="uemail" property="uemail" />
		</collection>
		<collection property="question" ofType="Question">
			<id column="qid" property="qid" />
			<result column="qautid" property="qautid" />
			<result column="qinid" property="qinid" />
			<result column="qtitle" property="qtitle" />
			<result column="qdetail" property="qdetail" />
			<result column="qtime" property="qtime" />
		</collection>
	</resultMap>


	<select id="listAnswer" parameterType="Users" resultMap="ReplyMap">
		select
		t.*,q.qtitle from
		(select r.*,u.uname,u.usign,r.reqid a from REPLY
		r,users u where remitid=#{uids}
		and uids=remitid) t,question q
		where
		t.reqid=a
	</select>

	<resultMap type="Essay" id="EssayMap">
		<id column="eid" property="eid" />
		<result column="eautid" property="eautid" />
		<result column="econtent" property="econtent" />
		<result column="etime" property="etime" />
		<result column="etitle" property="etitle" />
		<result column="escid" property="escid" />
		<result column="etid" property="etid" />
		<result column="ttopic" property="ttopic" />
		<result column="uname" property="uname" />
		<result column="usign" property="usign" />
		<collection property="users" ofType="Users">
			<id column="uids" property="uids" />
			<result column="upassword" property="upassword" />
			<result column="usign" property="usign" />
			<result column="uage" property="uage" />
			<result column="ugender" property="ugender" />
			<result column="uprofession" property="uprofession" />
			<result column="uname" property="uname" />
			<result column="upic" property="upic" />
			<result column="uemail" property="uemail" />
		</collection>
	</resultMap>

	<select id="listMyEssay" parameterType="Users" resultMap="EssayMap">
		select
		e.*,u.uname,u.usign,u.upic from ESSAY e,USERS u where eautid=#{uids}
	</select>

	<select id="listMyQuestion" parameterType="Users" resultType="Question">
		select q.*,t.sum from question q,
		(select count(reqid) sum from REPLY
		where rkind='Q' and reqid=(select reqid from question where
		qautid=#{uids})) t
		where q.qautid=#{uids}
	</select>

	<select id="listMyFavorite" parameterType="Users" resultType="Favorite">
		select f.*,t.sum from FAVORITE f,
		(select count(ids) sum from DYNSTATE
		where selfid=#{uids}) t
		where fcreid=#{uids}
	</select>

	<select id="listMyAttention" parameterType="Users" resultType="Users">
		select uname,usign,upic,
		(select count(remitid) from reply where
		remitid=(select d.aimid atten from
		DYNSTATE d where selfid=#{uids}) )
		ansum,
		(select count(eautid) from ESSAY where eautid=(select d.aimid
		atten from
		DYNSTATE d where selfid=#{uids}) ) essum,
		(select count(1)
		from DYNSTATE where aimid=(select d.aimid atten from
		DYNSTATE d where
		selfid=#{uids})) attsum
		from dual,users
		where uids=(select d.aimid atten
		from
		DYNSTATE d where selfid=#{uids})
	</select>


	<select id="totalatten" parameterType="Users" resultType="Users">
		select
		(select count(aimid) from dynstate where selfid=#{uids}) myatten,
		(select count(selfid) from DYNSTATE where aimid=#{uids}) attenme,
		(select count(ids) from DYNSTATE where selfid=#{uids} and kind='GH')
		myattentop,
		(select count(ids) from DYNSTATE where selfid=#{uids} and kind='GZ')
		myattenzhuanlan,
		(select count(ids) from DYNSTATE where selfid=#{uids} and kind='GS')
		myattenfav
		from dual
	</select>
	
	
	
	<insert id="insertGH" parameterType="String" >
		insert into dynstate(selfid,kind,ids,times) values(#{selfid},'GH',#{ids},to_char(sysdate,'yyyy-mm-dd'))
	</insert>
</mapper>